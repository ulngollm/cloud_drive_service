openapi: 3.0.3
info:
  title: Storage service
  description: Gateway API для работы с внешними хранилищами
  version: 1.0.3
servers:
  - url: 'http://localhost:8001/api/'
    description: dev url
tags:
  - name: info
    description: Информация о сервисе
  - name: manage
    description: Управление дисками
  - name: nav
    description: Навигация по файлам
  - name: demo
    description: Функционал для демо
paths:
  /storages/types/:
    get:
      tags:
        - info
      summary: Список драйверов
      responses:
        200:
          description: Список доступных типов хранилищ

  /storages/:
    get:
      security:
        - bearerAuth: [ ]
      tags:
        - nav
      summary: Список хранилищ пользователя
      responses:
        200:
          description: Список хранилищ авторизованного пользователя
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Storage'
    post:
      security:
        - bearerAuth: [ ]
      tags:
        - manage
      summary: Добавить хранилище
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InputStorage'
            examples:
              yandex:
                $ref: '#/components/examples/yandex'
      responses:
        200:
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Storage'

  /storages/{id}/:
    get:
      security:
        - bearerAuth: [ ]
      tags:
        - manage
      summary: Хранилище
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        200:
          description: Информация о хранилище
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Storage'
    patch:
      security:
        - bearerAuth: [ ]
      tags:
        - manage
      summary: Переименовать хранилище
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                label:
                  type: string
                  description: Новое название
                  example: 123456
      responses:
        200:
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Storage'
    delete:
      parameters:
        - in: path
          name: id
          description: id хранилища
          required: true
          schema:
            type: integer
      security:
        - bearerAuth: [ ]
      tags:
        - manage
      summary: Удалить хранилище
      description: soft delete
      responses:
        200:
          description: ok
  /storages/{id}/files/folder:
    get:
      security:
        - bearerAuth: [ ]
      tags:
        - nav
      summary: Список файлов папки
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: query
          name: path
          required: true
          schema:
            type: string
            default: /
      responses:
        200:
          description: Список файлов по указанному пути
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/File'
  /storages/{id}/files/{type}:
    get:
      security:
        - bearerAuth: [ ]
      tags:
        - nav
      summary: Фильтр по типам файлов
      description: |
        Сквозная фильтрация по типам файлов.
        
        Через Api яндекса доступны:  audio, backup, book, compressed, data, development, diskimage, document, encoded, executable, flash, font, image, settings, spreadsheet, text, unknown, video, web. 
        
        Из них поддеживаются только перечисленные в параметрах
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: path
          name: type
          required: true
          description: Тип файла
          schema:
            type: string
            enum:
              - video
              - audio
              - document
              - image
              - text
      responses:
        200:
          description: Список файлов диска указанного типа
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/File'
  /storages/{id}/files/:
    get:
      security:
        - bearerAuth: [ ]
      tags:
        - nav
      summary: Скачать файл
      description: Эндпоинт вернет файл в бинарном виде. На фронте его можно отобразить через blob
      parameters:
        - in: path
          name: id
          description: id диска
          required: true
          schema:
            type: integer
        - in: query
          name: path
          description: Путь к файлу в хранилище
          schema:
            type: string
          required: true
      responses:
        200:
          description: Бинарный файл
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
  /user:
    post:
      tags:
        - demo
      summary: Получить токен доступа
      description: |
        Создать нового пользователя и вернуть токен для его идентификации и аутентификации.
        
        При утере токена восстановить доступ к аккаунту невозможно.
      responses:
        200:
          description: Токен
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: Токен для временного пользователя
    delete:
      security:
        - bearerAuth: [ ]
      tags:
        - demo
      summary: Удалить пользователя
      description: |
        Удалить временного пользователя
      responses:
        200:
          description: Токен
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Результат удаления
                    example: true
        403:
          description: Неавторизован

components:
  parameters:
    id:
      name: id
      in: path
      required: true
      description: id хранилища
      schema:
        type: integer
  schemas:
    InputStorage:
      type: object
      properties:
        label:
          description: Пользовательское название для диска
          type: string
          default: Диск id
        driver:
          description: id типа драйвера
          type: integer
        credentials:
          type: object
          description: Доступы к хранилищу
    File:
      type: object
      properties:
        id:
          type: string
          description: идентификатор файла
        type:
          description: Обощенный тип файла - файл или директория
          type: string
          enum:
            - file
            - dir
        path:
          type: string
          description: Путь к файлу
        name:
          type: string
          description: Название файла
        mediaType:
          type: string
          nullable: true
          description: Обощенный медиатип. Использовать для отображения иконки
          enum:
            - video
            - audio
            - document
            - image
            - text
        mimeType:
          type: string
          description: mimetype файла
          example: image/jpeg
    Storage:
      type: object
      properties:
        id:
          type: integer
          description: Идентификатор хранилища
        label:
          type: string
          description: Пользовательское название хранилища
        type_id:
          type: integer
          description: |
            Идентификатор типа хранилища. 
            Доступные типы получить по эндпоинту /storages/types

  examples:
    yandex:
      summary: Яндекс Диск
      description: |
        Для добавления диска нужно передать OAuth токен. Его выдает Яндекс.
        
        Чтобы получить токен, перенаправить пользователя по адресу
        https://oauth.yandex.ru/authorize?response_type=token&client_id=4e2509198c704e87ab2a3e3a47be5e7e.
        Пользователь должен быть залогиненным в Яндекс и подтвердить доступ к своему диску.
      value:
        label: DS drive
        driver: 1
        credentials:
          token: AQAEA7qi7begAAfqC7jeGwAwxUpHhscXAXEEw
    ftp:
      summary: FTP
      description: |
        Подключениe ftp-хранилища. 
        
        Не реализовано. Только для примера, что в спецификации предусмотрено расширению функционала
      value:
        driver: 2
        credentials:
          username: admin
          password: 123456

  securitySchemes:
    bearerAuth:
      description: Токен пользователя, полученный через `POST` `/user`
      type: http
      scheme: bearer